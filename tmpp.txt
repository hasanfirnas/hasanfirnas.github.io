/**
 * This Office Script processes a table containing RITM data.
 * It finds all unique RITM numbers and returns ALL occurrences
 * of each RITM with their ID and CMDB Status information.
 */

// Define interfaces for our data structures
interface RitmEntry {
  Id: string;
  CMDB_Status: string;
}

interface RitmData {
  [key: string]: RitmEntry[];
}

interface ProcessingResult {
  summary: {
    total_unique_ritms: number;
    total_source_rows: number;
    total_entries_found: number;
  };
  data: RitmData;
}

function main(workbook: ExcelScript.Workbook): string {
  // ====================
  // 1. GET SOURCE TABLE
  // ====================
  const sourceSheet = workbook.getActiveWorksheet();
  const tables: ExcelScript.Table[] = sourceSheet.getTables();
  
  if (tables.length === 0) {
    return JSON.stringify({ error: "No table found on active worksheet" }, null, 2);
  }
  
  const sourceTable: ExcelScript.Table = tables[0];
  
  // ====================
  // 2. FIND COLUMN INDICES
  // ====================
  const sourceHeaders: string[] = sourceTable.getHeaderRowRange().getValues()[0] as string[];
  const sourceRange: ExcelScript.Range = sourceTable.getRangeBetweenHeaderAndTotal();
  const sourceData: (string | number | boolean)[][] = sourceRange.getValues() as (string | number | boolean)[][];
  const totalSourceRows: number = sourceData.length;
  
  // Find all required column indices
  const idColIndex: number = sourceHeaders.indexOf("Id");
  const ritmColIndex: number = sourceHeaders.findIndex(h => /^RITM/i.test(h));
  const cmdbStatusColIndex: number = sourceHeaders.indexOf("CMDB Status");
  
  // Validate critical columns
  if (idColIndex === -1) {
    return JSON.stringify({ error: "'Id' column not found in source table" }, null, 2);
  }
  
  if (ritmColIndex === -1) {
    return JSON.stringify({ error: "No RITM column found in source table" }, null, 2);
  }
  
  // ====================
  // 3. EXTRACT ALL RITM VALUES (AS STRINGS)
  // ====================
  const allRitmStrings: string[] = [];
  
  // First pass: Extract all RITM values as strings
  for (let i = 0; i < totalSourceRows; i++) {
    const ritmValue = sourceData[i][ritmColIndex];
    if (ritmValue) {
      allRitmStrings.push(ritmValue.toString().trim());
    }
  }
  
  // ====================
  // 4. REMOVE DUPLICATE RITM STRINGS ONLY
  // ====================
  const uniqueRitmStrings: string[] = [];
  const seenRitms = new Set<string>();
  
  for (const ritmString of allRitmStrings) {
    if (!seenRitms.has(ritmString)) {
      seenRitms.add(ritmString);
      uniqueRitmStrings.push(ritmString);
    }
  }
  
  // ====================
  // 5. FOR EACH UNIQUE RITM, FIND ALL MATCHING ROWS
  // ====================
  const ritmDataMap: RitmData = {};
  let totalEntriesFound = 0;
  
  // For each unique RITM string
  for (const ritmString of uniqueRitmStrings) {
    const entries: RitmEntry[] = [];
    
    // Search through ALL rows for this RITM
    for (let i = 0; i < totalSourceRows; i++) {
      const row = sourceData[i];
      const currentRitmValue = row[ritmColIndex];
      
      // Check if this row's RITM matches our current RITM
      if (currentRitmValue && currentRitmValue.toString().trim() === ritmString) {
        // Create entry object
        const entry: RitmEntry = {
          Id: (row[idColIndex] ? row[idColIndex].toString() : ""),
          CMDB_Status: (cmdbStatusColIndex !== -1 && row[cmdbStatusColIndex]) ? 
                        row[cmdbStatusColIndex].toString() : "N/A"
        };
        
        entries.push(entry);
        totalEntriesFound++;
      }
    }
    
    ritmDataMap[ritmString] = entries;
  }
  
  // ====================
  // 6. CREATE FINAL JSON STRUCTURE
  // ====================
  const result: ProcessingResult = {
    summary: {
      total_unique_ritms: uniqueRitmStrings.length,
      total_source_rows: totalSourceRows,
      total_entries_found: totalEntriesFound
    },
    data: ritmDataMap
  };
  
  // ====================
  // 7. RETURN THE FULL JSON
  // ====================
  return JSON.stringify(result, null, 2);
}
